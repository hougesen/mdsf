name: test
on:
  - push
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true
env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: full
jobs:
  tools:
    name: tools
    strategy:
      matrix:
        os:
          - ubuntu-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: Swatinem/rust-cache@v2
      - uses: erlef/setup-beam@v1
        with:
          elixir-version: 1.16.1
          gleam-version: 1.0.0
          otp-version: "26"
      - uses: actions/setup-python@v5
        with:
          cache: pip
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
      - uses: jiro4989/setup-nim-action@v2
      - uses: goto-bus-stop/setup-zig@v2
      - uses: uncenter/setup-taplo@v1
      - uses: actions/setup-go@v5
        with:
          go-version: stable
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
      - uses: dart-lang/setup-dart@v1
      - uses: crystal-lang/install-crystal@v1
      - uses: hasnep/setup-roc@v0.4.0
      - uses: denoland/setup-deno@v2
        with:
          deno-version: v1.x
      - uses: taiki-e/install-action@just
      - uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: "5.1"
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
      - uses: haskell-actions/setup@v2
        with:
          cabal-version: latest
          ghc-version: latest
      - uses: julia-actions/cache@v2
      - uses: cargo-bins/cargo-binstall@main
      - run: rustup toolchain install stable --profile minimal
      - run: rustup component add rustfmt clippy
      - name: pyink
        run: ( ( ( which pipx && pipx install pyink ) ) || echo "Unable to install tool" )
      - name: purs-tidy
        run: ( ( ( which npm && npm i -g purs-tidy ) ) || echo "Unable to install tool" )
      - name: mado
        run: ( ( ( which brew && brew tap akiomik/mado https://github.com/akiomik/mado.git &&  brew install mado ) ) || echo "Unable to install tool" )
      - name: fprettify
        run: ( ( ( which pipx && pipx install fprettify ) ) || echo "Unable to install tool" )
      - name: fantomas
        run: ( ( ( which dotnet && dotnet tool install -g fantomas ) ) || echo "Unable to install tool" )
      - name: ocp-indent
        run: ( ( ( which apt-get && sudo apt-get install -y ocp-indent ) ) || echo "Unable to install tool" )
      - name: csscomb
        run: ( ( ( which npm && npm i -g csscomb ) ) || echo "Unable to install tool" )
      - name: yamlfix
        run: ( ( ( which pipx && pipx install yamlfix ) ) || echo "Unable to install tool" )
      - name: autoflake
        run: ( ( ( which pipx && pipx install autoflake ) ) || echo "Unable to install tool" )
      - name: stylua
        run: ( ( ( which npm && npm i -g @johnnymorganz/stylua-bin ) || ( which cargo && ( cargo binstall stylua || cargo install stylua ) ) ) || echo "Unable to install tool" )
      - name: tofu
        run: ( ( ( which brew &&  brew install opentofu ) ) || echo "Unable to install tool" )
      - name: alejandra
        run: ( ( ( which cargo && ( cargo binstall alejandra || cargo install alejandra ) ) ) || echo "Unable to install tool" )
      - name: scalafmt
        run: ( ( ( which cs && cs install scalafmt ) ) || echo "Unable to install tool" )
      - name: sql-formatter
        run: ( ( ( which npm && npm i -g sql-formatter ) ) || echo "Unable to install tool" )
      - name: ormolu
        run: ( ( ( which apt-get && sudo apt-get install -y ormolu ) ) || echo "Unable to install tool" )
      - name: prisma
        run: ( ( ( which npm && npm i -g prisma ) ) || echo "Unable to install tool" )
      - name: markdownlint-cli2
        run: ( ( ( which npm && npm i -g markdownlint-cli2 ) ) || echo "Unable to install tool" )
      - name: blue
        run: ( ( ( which pipx && pipx install blue ) ) || echo "Unable to install tool" )
      - name: markdownfmt
        run: ( ( ( which go && go install github.com/shurcooL/markdownfmt@latest ) ) || echo "Unable to install tool" )
      - name: html-beautify
        run: ( ( ( which npm && npm i -g js-beautify ) ) || echo "Unable to install tool" )
      - name: rubyfmt
        run: ( ( ( which brew &&  brew install rubyfmt ) ) || echo "Unable to install tool" )
      - name: biome
        run: ( ( ( which npm && npm i -g @biomejs/biome ) ) || echo "Unable to install tool" )
      - name: xmllint
        run: ( ( ( which apt-get && sudo apt-get install -y libxml2-utils ) ) || echo "Unable to install tool" )
      - name: pycln
        run: ( ( ( which pipx && pipx install pycln ) ) || echo "Unable to install tool" )
      - name: dotnet
        run: ( ( ( which dotnet && dotnet tool install -g csharpier ) ) || echo "Unable to install tool" )
      - name: black
        run: ( ( ( which pipx && pipx install black ) ) || echo "Unable to install tool" )
      - name: goimports
        run: ( ( ( which go && go install golang.org/x/tools/cmd/goimports@latest ) ) || echo "Unable to install tool" )
      - name: ktlint
        run: ( ( ( which brew &&  brew install ktlint ) ) || echo "Unable to install tool" )
      - name: just
        run: ( ( ( which npm && npm i -g rust-just ) || ( which cargo && ( cargo binstall just || cargo install just ) ) || ( which brew &&  brew install just ) || ( which pipx && pipx install rust-just ) ) || echo "Unable to install tool" )
      - name: css-beautify
        run: ( ( ( which npm && npm i -g js-beautify ) ) || echo "Unable to install tool" )
      - name: yamlfmt
        run: ( ( ( which go && go install github.com/google/yamlfmt/cmd/yamlfmt@latest ) ) || echo "Unable to install tool" )
      - name: ktfmt
        run: ( ( ( which brew &&  brew install ktfmt ) ) || echo "Unable to install tool" )
      - name: standardrb
        run: ( ( ( which gem && gem install standardrb ) ) || echo "Unable to install tool" )
      - name: markdownlint
        run: ( ( ( which npm && npm i -g markdownlint-cli ) ) || echo "Unable to install tool" )
      - name: efmt
        run: ( ( ( which cargo && ( cargo binstall efmt || cargo install efmt ) ) ) || echo "Unable to install tool" )
      - name: shfmt
        run: ( ( ( which go && go install mvdan.cc/sh/v3/cmd/shfmt@latest ) ) || echo "Unable to install tool" )
      - name: terraform
        run: ( ( ( which brew && brew tap hashicorp/tap &&  brew install hashicorp/tap/terraform ) ) || echo "Unable to install tool" )
      - name: actionlint
        run: ( ( ( which go && go install github.com/rhysd/actionlint/cmd/actionlint@latest ) ) || echo "Unable to install tool" )
      - name: ocamlformat
        run: ( ( ( which opam && eval $(opam env) && opam install ocamlformat ) ) || echo "Unable to install tool" )
      - name: clang-format
        run: ( ( ( which pipx && pipx install clang-format ) ) || echo "Unable to install tool" )
      - name: julia
        run: ( ( ( which julia && julia  -e 'import Pkg; Pkg.add("JuliaFormatter")' ) ) || echo "Unable to install tool" )
      - name: ruff
        run: ( ( ( which pipx && pipx install ruff ) ) || echo "Unable to install tool" )
      - name: kcl
        run: ( ( ( which go && go install kcl-lang.io/cli/cmd/kcl@latest ) ) || echo "Unable to install tool" )
      - name: sqlfluff
        run: ( ( ( which pipx && pipx install sqlfluff ) ) || echo "Unable to install tool" )
      - name: swiftformat
        run: ( ( ( which brew &&  brew install swiftformat ) ) || echo "Unable to install tool" )
      - name: auto-optional
        run: ( ( ( which pipx && pipx install auto-optional ) ) || echo "Unable to install tool" )
      - name: taplo
        run: ( ( ( which npm && npm i -g @taplo/cli ) ) || echo "Unable to install tool" )
      - name: isort
        run: ( ( ( which pipx && pipx install isort ) ) || echo "Unable to install tool" )
      - name: rescript
        run: ( ( ( which npm && npm i -g rescript ) ) || echo "Unable to install tool" )
      - name: yew-fmt
        run: ( ( ( which cargo && ( cargo binstall yew-fmt || cargo install yew-fmt ) ) ) || echo "Unable to install tool" )
      - name: yapf
        run: ( ( ( which pipx && pipx install yapf ) ) || echo "Unable to install tool" )
      - name: autopep8
        run: ( ( ( which pipx && pipx install autopep8 ) ) || echo "Unable to install tool" )
      - name: usort
        run: ( ( ( which pipx && pipx install usort ) ) || echo "Unable to install tool" )
      - name: nixpkgs-fmt
        run: ( ( ( which cargo && ( cargo binstall nixpkgs-fmt || cargo install nixpkgs-fmt ) ) ) || echo "Unable to install tool" )
      - name: xmlformat
        run: ( ( ( which pipx && pipx install xmlformatter ) ) || echo "Unable to install tool" )
      - name: buf
        run: ( ( ( which npm && npm i -g @bufbuild/buf ) ) || echo "Unable to install tool" )
      - name: prettier
        run: ( ( ( which npm && npm i -g prettier ) ) || echo "Unable to install tool" )
      - name: rufo
        run: ( ( ( which gem && gem install rufo ) ) || echo "Unable to install tool" )
      - name: brunette
        run: ( ( ( which pipx && pipx install brunette ) ) || echo "Unable to install tool" )
      - name: topiary
        run: ( ( ( which cargo && ( cargo binstall topiary-cli || cargo install topiary-cli ) ) ) || echo "Unable to install tool" )
      - name: gofumpt
        run: ( ( ( which go && go install mvdan.cc/gofumpt@latest ) ) || echo "Unable to install tool" )
      - name: npm-groovy-lint
        run: ( ( ( which npm && npm i -g npm-groovy-lint ) ) || echo "Unable to install tool" )
      - name: elm-format
        run: ( ( ( which npm && npm i -g elm-format ) ) || echo "Unable to install tool" )
      - name: typos
        run: ( ( ( which cargo && ( cargo binstall typos-cli || cargo install typos-cli ) ) ) || echo "Unable to install tool" )
      - name: blade-formatter
        run: ( ( ( which npm && npm i -g blade-formatter ) ) || echo "Unable to install tool" )
      - name: golines
        run: ( ( ( which go && go install github.com/segmentio/golines@latest ) ) || echo "Unable to install tool" )
      - name: stylefmt
        run: ( ( ( which npm && npm i -g stylefmt ) ) || echo "Unable to install tool" )
      - name: rubocop
        run: ( ( ( which gem && gem install rubocop ) ) || echo "Unable to install tool" )
      - name: htmlbeautifier
        run: ( ( ( which gem && gem install htmlbeautifier ) ) || echo "Unable to install tool" )
      - name: Run tests
        run: cargo test
      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov
      - name: Generate code coverage
        run: cargo llvm-cov --all-features --locked --lcov --output-path lcov.info
      - name: Upload code coverage
        uses: codecov/codecov-action@v5
        with:
          files: lcov.info
          slug: hougesen/mdsf
          token: ${{ secrets.CODECOV_TOKEN }}
